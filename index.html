<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MacroCalc</title>
  <script src="//cdn.tailwindcss.com"></script>
  <script src="//unpkg.com/papaparse"></script>
  <script src="//unpkg.com/petite-vue"></script>
  <script src="//www.gstatic.com/charts/loader.js"></script>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

</head>

<body class="bg-gray-100 text-gray-900">
  <div id="app" class="mx-auto p-4 max-w-full lg:max-w-[800px] overflow-x-hidden">
    <div class="flex justify-center">
      <h1 class="text-2xl font-bold mb-4">MacroCalc</h1>
    </div>

    <div class="mt-4 overflow-x-auto" v-show="ingredients.length">
      <table class="w-full text-xs sm:text-sm">
        <thead>
          <tr class="border-b border-gray-300">
            <th class="px-2 py-2">
              <span class="sm:hidden"></span>
              <span class="hidden sm:block">Ingredient</span>
            </th>
            <th class="px-2 py-2">
              <span class="sm:hidden">Amt</span>
              <span class="hidden sm:block">Amount</span>
            </th>
            <th class="px-2 py-2">
              <span class="sm:hidden">F</span>
              <span class="hidden sm:block">Fat</span>
            </th>
            <th class="px-2 py-2">
              <span class="sm:hidden">C</span>
              <span class="hidden sm:block">Carbs</span>
            </th>
            <th class="px-2 py-2">
              <span class="sm:hidden">P</span>
              <span class="hidden sm:block">Protein</span>
            </th>
            <th class="px-2 py-2">
              <span class="sm:hidden">kcal</span>
              <span class="hidden sm:block">Calories</span>
            </th>
            <th class="px-2 py-2">
              <span class="sm:hidden"></span>
              <span class="hidden sm:block">Actions</span>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="ingredient in ingredients" :key="ingredient.name" class="border-b border-gray-300">
            <td class="px-2 py-2 text-center">{{ ingredient.name }}</td>
            <td class="px-2 py-2 text-center">{{ ingredient.grams.toFixed(1) }}g</td>
            <td class="px-2 py-2 text-center">{{ ingredient.fat.toFixed(1) }}g</td>
            <td class="px-2 py-2 text-center">{{ ingredient.carbs.toFixed(1) }}g</td>
            <td class="px-2 py-2 text-center">{{ ingredient.protein.toFixed(1) }}g</td>
            <td class="px-2 py-2 text-center">{{ (ingredient.kcal).toFixed(1) }}kcal</td>
            <td class="px-2 py-2 text-center">
              <button @click="delIngredient(ingredient)"
                class="h-4 w-4 bg-red-500 text-white text-xs rounded align-middle inline-block mx-auto">&#x2715;</button>
          </tr>
        </tbody>
        <tfoot>
          <tr class="">
            <th class="pt-8 text-center uppercase">Total</th>
            <th class="pt-8 text-center">{{ totalGrams().toFixed(1) }}g</th>
            <th class="pt-8 text-center">{{ totalFat().toFixed(1) }}g</th>
            <th class="pt-8 text-center">{{ totalCarbs().toFixed(1) }}g</th>
            <th class="pt-8 text-center">{{ totalProtein().toFixed(1) }}g</th>
            <th class="pt-8 text-center">{{ (totalKcal()).toFixed(1) }}kcal</th>
            <th class="pt-8 text-center">
              <!-- <i class="h-4 w-4 bi bi-floppy2-fill cursor-pointer"></i> -->
            </th>
          </tr>
        </tfoot>
      </table>
    </div>

    <hr class="my-4 border-b-2 border-gray-300" />

    <div v-show="ingredients.length" class="w-full sm:w-auto my-auto mt-4">
      <div id="macro-chart" class="flex max-w-[450px] h-[250px] mx-auto justify-center"></div>
    </div>

    <div class="flex flex-wrap justify-center mt-4 h-8">
      <div v-show="error" class="text-red-200">
        <i class="bi bi-exclamation-lg h-4 w-4"></i>
        <span>{{error}}</span>
      </div>
      <div v-show="status">
        <div class="animate-spin inline-block"><i class="bi bi-arrow-clockwise h-4 w-4"></i></div>
        <span>{{status}}</span>
      </div>
    </div>

    <div class="flex flex-wrap justify-center mt-4 space-x-0 sm:space-x-4">

      <div class="w-full sm:w-auto my-auto">
        <label for="grams" class="block">Grams</label>
        <input :disabled="disabled" id="grams" type="number" class="block w-full px-2 py-1 rounded"
          v-model.number="gramsAdded" />
      </div>

      <div class="w-full sm:w-auto my-auto">
        <label for="ingredient" class="block">Ingredient</label>
        <input :disabled="disabled" id="ingredient" class="block w-full px-2 py-1 rounded" type="text"
          @keyup="lookupIngredient($event.target.value)" v-model="ingredientName" />
      </div>

    </div>

    <div class="w-full sm:w-auto my-auto mt-4 space-y-2" v-show="ingredientChoices.length">
      <div v-for="product in ingredientChoices" class="cursor-pointer" @click="parseProduct(product)"
        class="flex items-center justify-start inline-block w-32">
        <div class="text-sm p-1 text-blue-500 border border-blue-500 rounded hover:text-blue-700 hover:border-blue-700 flex flex-row">
          <span class="flex-grow">{{ product.title }}</span><span class="font-mono text-nowrap">{{ product.nlabel }}</span>
        </div>
      </div>
    </div>


  </div>

  <script type="module" async>

    // Asynchronously load Google Charts.
    google.charts.load('current', { 'packages': ['corechart'] });

    // Super secret, high-level security.
    const API_KEY_1 = 'TECNS4mXvDoMJgtBqeJG';
    const API_KEY_2 = 'OmbTyuzaBlC3eGme0gru';
    const FOOD_DATA_URL = 'https://api.nal.usda.gov/fdc/v1';

    function parseNutrients(nutrients) {
      const x = nutrients.reduce((agg, n) => ({...agg, [n.nutrientName]: n.value}), {});
      return {
        kcal: x['Energy'] || null,
        protein: x['Protein'] || null,
        fat: x['Total lipid (fat)'] || null,
        carbs: x['Carbohydrate, by difference'] || null,
        fiber: x['Fiber, total dietary'] || null,
        sugar: x['Total Sugars'] || null,
      }
    }

    PetiteVue.createApp({
      error: null,
      status: null,
      disabled: false,
      ingredients: [],
      gramsAdded: 100,
      ingredientName: null,
      ingredientChoices: [],
      ingredientLookupTimer: null,

      addIngredient: function (macros) {
        const grams = this.gramsAdded;
        const ratio = grams / 100;
        this.ingredients.push(Object.assign({}, macros, {
          name: this.ingredientName,
          grams: grams,
          fat: ratio * macros?.fat || 0,
          carbs: ratio * macros?.carbs || 0,
          protein: ratio * macros?.protein || 0,
          kj: ratio * macros?.kj || 0,
          price: ratio * macros?.price || 0,
        }));

        this.ingredientName = null;
        this.gramsAdded = 100;

        setTimeout(() => this.updateChart(), 100);
      },

      delIngredient: function (ingredient) {
        this.ingredients = this.ingredients.filter(i => i !== ingredient);
        this.updateChart();
      },

      lookupIngredient: function (ingredientName) {
        if (this.ingredientLookupTimer) clearTimeout(this.ingredientLookupTimer);
        this.ingredientLookupTimer = setTimeout(async () => {
          this.ingredientChoices = [];
          const searchUrl = new URL(`${FOOD_DATA_URL}/foods/search`);
          searchUrl.searchParams.set('api_key', `${API_KEY_1}${API_KEY_2}`);
          searchUrl.searchParams.set('query', ingredientName);
          searchUrl.searchParams.set('dataType', 'Branded');

          this.status = 'searching products...';
          
          const searchResults = await fetch(searchUrl).then((res) => res.json());
          this.ingredientChoices = searchResults.foods
            .map((x) => {
              const n = parseNutrients(x.foodNutrients);
              return {
                id: x.fdcId,
                title: `${x.description} (${x.brandName})`,
                nlabel: `${n.protein}p ${n.carbs}c ${n.fat}f`,
                url: `https://fdc.nal.usda.gov/food-details/${x.fdcId}/nutrients`,
                ...n,
              }
            })
            .filter((x) => x.kcal && x.protein && x.carbs && x.fat);
          this.status = null;
        }, 400);
      },

      parseProduct: async function (product) {
        this.disabled = true;
        this.ingredientChoices = [];
        this.addIngredient(product);
        this.status = null;
        this.disabled = false;
      },

      updateChart: function () {
        const data = google.visualization.arrayToDataTable([
          ['Macro', 'Grams'],
          ['Protein', this.totalProtein() || 0],
          ['Carbs', this.totalCarbs() || 0],
          ['Fat', this.totalFat() || 0],
        ]);

        const options = {
          legend: { position: 'top', textStyle: { fontSize: 16 } },
          pieHole: 0.4,
          width: 450,
          height: 300,
          backgroundColor: { fill: 'transparent' },
        };

        const chart = new google.visualization.PieChart(document.getElementById('macro-chart'));
        chart.draw(data, options);
      },

      totalGrams: function () {
        return this.ingredients.reduce((sum, i) => sum + i.grams, 0);
      },
      totalKcal: function () {
        return this.ingredients.reduce((sum, i) => sum + i.kcal, 0);
      },
      totalProtein: function () {
        return this.ingredients.reduce((sum, i) => sum + i.protein, 0);
      },
      totalFat: function () {
        return this.ingredients.reduce((sum, i) => sum + i.fat, 0);
      },
      totalCarbs: function () {
        return this.ingredients.reduce((sum, i) => sum + i.carbs, 0);
      },
      totalPrice: function () {
        return this.ingredients.reduce((sum, i) => sum + i.price, 0);
      },

    }).mount();
  </script>
</body>

</html>
